# GitHub Actions CI/CD Setup

## Что делает этот CI/CD

При пуше в ветку `main` автоматически:
1. Определяет, какие сервисы изменились (backend, frontend, или оба)
2. Собирает Docker образы для Linux (amd64) с оптимизацией через BuildKit
3. Загружает образы в AWS ECR
4. Обновляет ECS сервисы для автоматического деплоя

## Оптимизации

Система использует несколько оптимизаций для ускорения деплоя:

### 1. Docker BuildKit
- Параллельная сборка слоев
- Улучшенное кэширование
- Оптимизированные multi-stage builds

### 2. Кэширование зависимостей
- **Frontend**: Кэширование `node_modules` через GitHub Actions cache
- **Backend**: Кэширование pip dependencies через GitHub Actions cache
- Кэш автоматически инвалидируется при изменении `package-lock.json` или `requirements.txt`

### 3. ECR Layer Caching
- Использование предыдущих образов (`:latest`) как cache source
- Ускорение сборки при неизменных слоях
- `--cache-from` для оптимизации Docker builds

### 4. Параллельный деплой
- При изменении обоих сервисов они деплоятся параллельно
- Matrix strategy для одновременной сборки и деплоя
- Умная логика определения изменений

### 5. Оптимизированные Dockerfile'ы
- Разделение слоев для лучшего кэширования
- Mount cache для npm (frontend)
- Оптимизированный порядок команд

**Ожидаемое время деплоя:** 3-4 минуты (вместо 10 минут)

## Настройка (один раз)

### 1. Добавьте секреты в GitHub

1. Перейдите в ваш репозиторий на GitHub
2. Нажмите **Settings** → **Secrets and variables** → **Actions**
3. Нажмите **New repository secret**
4. Добавьте следующие секреты:

   - **Имя:** `AWS_ACCESS_KEY_ID`
     **Значение:** (ваш AWS Access Key ID)

   - **Имя:** `AWS_SECRET_ACCESS_KEY`
     **Значение:** (ваш AWS Secret Access Key)

### 2. Проверка

После добавления секретов:
- При следующем пуше в `main` автоматически запустится деплой
- Можно также запустить вручную: **Actions** → выберите workflow → **Run workflow**

## Как это работает

### Объединенный workflow (deploy.yml) - Рекомендуется

**Триггер:** Изменения в `backend/`, `frontend/`, или workflow файлах

**Логика:**
1. Определяет, какие сервисы изменились
2. Деплоит только измененные сервисы
3. При изменении обоих сервисов - деплоит их параллельно
4. При ручном запуске (`workflow_dispatch`) - деплоит оба сервиса

**Преимущества:**
- Параллельный деплой ускоряет процесс
- Умная логика деплоит только то, что изменилось
- Один workflow вместо двух

### Отдельные workflows (для обратной совместимости)

#### Backend workflow (deploy-backend.yml)
- Триггер: изменения в `backend/` или сам workflow файл
- Собирает образ из `backend/Dockerfile`
- Деплоит в `doctor-agent-backend` сервис
- Использует все оптимизации (BuildKit, кэширование)

#### Frontend workflow (deploy-frontend.yml)
- Триггер: изменения в `frontend/` или сам workflow файл
- Собирает образ из `frontend/Dockerfile`
- Деплоит в `doctor-agent-frontend` сервис
- Использует все оптимизации (BuildKit, кэширование)

## Мониторинг

Проверить статус деплоя:
- GitHub: **Actions** вкладка в репозитории
- AWS Console: ECS → Clusters → doctor-agent-cluster → Services

## Ручной запуск

Если нужно задеплоить вручную:
1. GitHub → **Actions**
2. Выберите нужный workflow:
   - **Deploy** - деплоит оба сервиса параллельно (рекомендуется)
   - **Deploy Backend** - только бэкенд
   - **Deploy Frontend** - только фронтенд
3. Нажмите **Run workflow** → **Run workflow**

## Детали оптимизаций

### Кэширование зависимостей

**Frontend:**
- Кэш ключ: `${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}`
- Автоматически инвалидируется при изменении `package-lock.json`
- Восстанавливается между запусками workflow

**Backend:**
- Кэш ключ: `${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}`
- Автоматически инвалидируется при изменении `requirements.txt`
- Восстанавливается между запусками workflow

### ECR Layer Caching

- Перед сборкой пытается загрузить предыдущий образ (`:latest`)
- Использует его как cache source через `--cache-from`
- Если образа нет - просто пропускает кэш (безопасно)
- Ускоряет сборку при неизменных слоях

### BuildKit

- Включен через `DOCKER_BUILDKIT=1`
- Параллельная сборка независимых слоев
- Улучшенное кэширование и оптимизация
- Поддерживается всеми GitHub Actions runners

