name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch: # ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ

env:
  AWS_REGION: me-central-1
  ECS_CLUSTER: doctor-agent-cluster
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      services: ${{ steps.set-matrix.outputs.services }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
              - '.github/workflows/deploy.yml'
              - '.github/workflows/deploy-backend.yml'
            frontend:
              - 'frontend/**'
              - '.github/workflows/deploy.yml'
              - '.github/workflows/deploy-frontend.yml'

      - name: Set services matrix
        id: set-matrix
        run: |
          SERVICES="[]"
          if [ "${{ steps.filter.outputs.backend }}" == "true" ]; then
            SERVICES=$(echo $SERVICES | jq -c '. += ["backend"]')
          fi
          if [ "${{ steps.filter.outputs.frontend }}" == "true" ]; then
            SERVICES=$(echo $SERVICES | jq -c '. += ["frontend"]')
          fi
          # Ğ•ÑĞ»Ğ¸ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¾ÑÑŒ, Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ğ¼ Ğ¾Ğ±Ğ° (Ğ´Ğ»Ñ workflow_dispatch)
          if [ "$SERVICES" == "[]" ]; then
            SERVICES='["backend","frontend"]'
          fi
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "Will deploy: $SERVICES"

  deploy:
    name: Deploy ${{ matrix.service }}
    needs: detect-changes
    if: needs.detect-changes.outputs.services != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
    env:
      ECR_REPOSITORY: doctor-agent-${{ matrix.service }}
      ECS_SERVICE: doctor-agent-${{ matrix.service }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Cache dependencies
        if: matrix.service == 'frontend'
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Cache pip dependencies
        if: matrix.service == 'backend'
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Pull previous image for cache
        id: pull-cache
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker pull $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest || echo "No previous image found, will build from scratch"

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: latest
        run: |
          cd ${{ matrix.service }}
          if [ "${{ matrix.service }}" == "frontend" ]; then
            docker build \
              --platform linux/amd64 \
              --cache-from $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest \
              --build-arg BUILDKIT_INLINE_CACHE=1 \
              --build-arg NEXT_PUBLIC_API_URL=https://agents.elemental.ae \
              --build-arg NEXT_PUBLIC_WS_URL=wss://agents.elemental.ae \
              -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG \
              .
          else
            docker build \
              --platform linux/amd64 \
              --cache-from $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest \
              -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG \
              .
          fi
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
          echo "image=$ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Force new ECS deployment
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Show initial task status
        run: |
          echo "ğŸ“Š Initial task status for ${{ matrix.service }}:"
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].[serviceName,runningCount,desiredCount,status]' \
            --output table
          
          echo ""
          echo "ğŸ“‹ Current tasks:"
          TASK_ARNS=$(aws ecs list-tasks \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service-name ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'taskArns' \
            --output text)
          
          if [ -n "$TASK_ARNS" ]; then
            aws ecs describe-tasks \
              --cluster ${{ env.ECS_CLUSTER }} \
              --tasks $TASK_ARNS \
              --region ${{ env.AWS_REGION }} \
              --query 'tasks[*].[taskArn,lastStatus,healthStatus,desiredStatus,stoppedReason]' \
              --output table
          else
            echo "No tasks found yet"
          fi

      - name: Wait for deployment to stabilize
        run: |
          echo "â³ Waiting for ${{ matrix.service }} deployment to stabilize..."
          echo "This may take a few minutes..."
          echo ""
          
          # Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ñ‚Ğ°ÑĞºĞ¾Ğ²
          show_task_status() {
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š Task Status Check ($(date +%H:%M:%S)):"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑ€Ğ²Ğ¸ÑĞ°
            SERVICE_STATUS=$(aws ecs describe-services \
              --cluster ${{ env.ECS_CLUSTER }} \
              --services ${{ env.ECS_SERVICE }} \
              --region ${{ env.AWS_REGION }} \
              --query 'services[0].[runningCount,desiredCount,status]' \
              --output text)
            
            echo "Service: Running/Desired/Status: $SERVICE_STATUS"
            echo ""
            
            # Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ°ÑĞºĞ¾Ğ²
            TASK_ARNS=$(aws ecs list-tasks \
              --cluster ${{ env.ECS_CLUSTER }} \
              --service-name ${{ env.ECS_SERVICE }} \
              --region ${{ env.AWS_REGION }} \
              --query 'taskArns' \
              --output text)
            
            if [ -n "$TASK_ARNS" ]; then
              echo "Tasks:"
              aws ecs describe-tasks \
                --cluster ${{ env.ECS_CLUSTER }} \
                --tasks $TASK_ARNS \
                --region ${{ env.AWS_REGION }} \
                --query 'tasks[*].[taskArn,lastStatus,healthStatus,desiredStatus,createdAt]' \
                --output table
              
              # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ñ‚Ğ°ÑĞºĞ¾Ğ² Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ğ¼Ğ¸
              STOPPED_TASKS=$(aws ecs describe-tasks \
                --cluster ${{ env.ECS_CLUSTER }} \
                --tasks $TASK_ARNS \
                --region ${{ env.AWS_REGION }} \
                --query 'tasks[?lastStatus==`STOPPED`]' \
                --output json)
              
              if [ "$STOPPED_TASKS" != "[]" ] && [ -n "$STOPPED_TASKS" ]; then
                echo ""
                echo "âš ï¸  Stopped tasks with errors:"
                echo "$STOPPED_TASKS" | jq -r '.[] | "Task: \(.taskArn)\n  Status: \(.lastStatus)\n  Reason: \(.stoppedReason // "N/A")\n  Exit Code: \(.containers[0].exitCode // "N/A")\n  Stop Code: \(.stopCode // "N/A")\n"'
              fi
            else
              echo "No tasks found yet"
            fi
            echo ""
          }
          
          # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 30 ÑĞµĞºÑƒĞ½Ğ´ Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ
          (
            while true; do
              sleep 30
              show_task_status
            done
          ) &
          STATUS_PID=$!
          
          # Ğ–Ğ´ĞµĞ¼ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
          if aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }}; then
            kill $STATUS_PID 2>/dev/null || true
            echo "âœ… Service is stable!"
          else
            kill $STATUS_PID 2>/dev/null || true
            echo "âš ï¸  Wait timeout or service not stable"
          fi

      - name: Deployment status and task details
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Final Deployment Status for ${{ matrix.service }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑ€Ğ²Ğ¸ÑĞ°
          echo ""
          echo "Service Status:"
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].[serviceName,runningCount,desiredCount,status]' \
            --output table
          
          # Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ‚Ğ°ÑĞºĞ°Ñ…
          echo ""
          echo "Task Details:"
          TASK_ARNS=$(aws ecs list-tasks \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service-name ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'taskArns' \
            --output text)
          
          if [ -n "$TASK_ARNS" ]; then
            # Ğ’ÑĞµ Ñ‚Ğ°ÑĞºĞ¸
            aws ecs describe-tasks \
              --cluster ${{ env.ECS_CLUSTER }} \
              --tasks $TASK_ARNS \
              --region ${{ env.AWS_REGION }} \
              --query 'tasks[*].[taskArn,lastStatus,healthStatus,desiredStatus,createdAt,startedAt]' \
              --output table
            
            # ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ñ‚Ğ°ÑĞºĞ¸ Ñ Ğ´ĞµÑ‚Ğ°Ğ»ÑĞ¼Ğ¸ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
            STOPPED_TASKS=$(aws ecs describe-tasks \
              --cluster ${{ env.ECS_CLUSTER }} \
              --tasks $TASK_ARNS \
              --region ${{ env.AWS_REGION }} \
              --query 'tasks[?lastStatus==`STOPPED`]' \
              --output json)
            
            if [ "$STOPPED_TASKS" != "[]" ] && [ -n "$STOPPED_TASKS" ]; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âŒ Stopped Tasks (Errors):"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "$STOPPED_TASKS" | jq -r '.[] | "
                Task ARN: \(.taskArn)
                Status: \(.lastStatus)
                Desired Status: \(.desiredStatus)
                Stop Code: \(.stopCode // "N/A")
                Stopped Reason: \(.stoppedReason // "N/A")
                Exit Code: \(.containers[0].exitCode // "N/A")
                Container Reason: \(.containers[0].reason // "N/A")
                Created: \(.createdAt)
                Started: \(.startedAt // "N/A")
                Stopped: \(.stoppedAt // "N/A")
                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              "'
            fi
            
            # Ğ—Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ğµ Ñ‚Ğ°ÑĞºĞ¸
            RUNNING_TASKS=$(aws ecs describe-tasks \
              --cluster ${{ env.ECS_CLUSTER }} \
              --tasks $TASK_ARNS \
              --region ${{ env.AWS_REGION }} \
              --query 'tasks[?lastStatus==`RUNNING`]' \
              --output json)
            
            if [ "$RUNNING_TASKS" != "[]" ] && [ -n "$RUNNING_TASKS" ]; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… Running Tasks:"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "$RUNNING_TASKS" | jq -r '.[] | "
                Task ARN: \(.taskArn)
                Status: \(.lastStatus)
                Health: \(.healthStatus // "N/A")
                Created: \(.createdAt)
                Started: \(.startedAt // "N/A")
                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              "'
            fi
          else
            echo "âš ï¸  No tasks found!"
          fi
          
          # Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ° (Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 5)
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Recent Service Events (last 5):"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].events[:5]' \
            --output table

