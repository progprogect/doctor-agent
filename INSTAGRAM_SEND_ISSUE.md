# –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Instagram

## –¢–µ–∫—É—â–∞—è –æ—à–∏–±–∫–∞

```
Error Code: 100 (subcode: 2534014)
Message: "ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®." (User not found)
```

## –ü—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏

### 1. **24-—á–∞—Å–æ–≤–æ–µ –æ–∫–Ω–æ –æ—Ç–≤–µ—Ç–æ–≤**
- Instagram –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–∏—Å–∞–ª –∞–≥–µ–Ω—Ç—É –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞

### 2. **–ù–µ–≤–µ—Ä–Ω—ã–π recipient_id**
- `recipient_id` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **Instagram User ID** (–Ω–µ Account ID)
- –≠—Ç–æ—Ç ID –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å **—Ç–æ–ª—å–∫–æ –∏–∑ webhook —Å–æ–±—ã—Ç–∏—è** (`sender.id`)
- Account ID (`25638311079121978`) ‚â† User ID –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏

### 3. **Self Messaging —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π ID**
- –î–ª—è Self Messaging –Ω—É–∂–µ–Ω **Instagram-scoped ID** –∏–∑ webhook —Å–æ–±—ã—Ç–∏—è
- –≠—Ç–æ—Ç ID –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ webhook –∫–æ–≥–¥–∞:
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∞–º–æ–º—É —Å–µ–±–µ —á–µ—Ä–µ–∑ Instagram app
  - Webhook —Å–æ–¥–µ—Ä–∂–∏—Ç `is_self: true` –∏ `is_echo: true`
  - `recipient.id` –≤ —ç—Ç–æ–º webhook = Instagram-scoped ID –¥–ª—è Self Messaging

## –†–µ—à–µ–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–±)

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –Ω–∞–ø–∏—Å–∞—Ç—å –∞–≥–µ–Ω—Ç—É –≤ Instagram**
   - –≠—Ç–æ –æ—Ç–∫—Ä–æ–µ—Ç 24-—á–∞—Å–æ–≤–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤
   - Webhook —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏–¥–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
   - –ò–∑ webhook –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å `sender.id` (—ç—Ç–æ –∏ –µ—Å—Ç—å `recipient_id` –¥–ª—è –æ—Ç–≤–µ—Ç–∞)

2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `sender.id` –∏–∑ webhook –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞**

### –í–∞—Ä–∏–∞–Ω—Ç 2: Self Messaging (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–∞–º–æ–º—É —Å–µ–±–µ)

1. **–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∞–º–æ–º—É —Å–µ–±–µ —á–µ—Ä–µ–∑ Instagram app**
   - –û—Ç–∫—Ä–æ–π—Ç–µ Instagram app
   - –ù–∞–π–¥–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç `@beautician_test`
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∞–º–æ–º—É —Å–µ–±–µ

2. **–ü–æ–ª—É—á–∏—Ç—å webhook —Å–æ–±—ã—Ç–∏–µ**
   - –°–æ–±—ã—Ç–∏–µ –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
     ```json
     {
       "is_self": true,
       "is_echo": true,
       "recipient": {
         "id": "INSTAGRAM_SCOPED_ID_–ó–î–ï–°–¨"
       }
     }
     ```

3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `recipient.id` –∏–∑ webhook –¥–ª—è Self Messaging**
   - –§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞:
     ```
     POST /{INSTAGRAM_SCOPED_ID}/messages
     Body: {"message": {"text": "..."}}
     ```
   - **–ë–ï–ó –ø–æ–ª—è `recipient`!**

## –ü—Ä–æ–≤–µ—Ä–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ webhook —Å–æ–±—ã—Ç–∏—è:

```bash
curl http://doctor-agent-alb-1328234230.me-central-1.elb.amazonaws.com/api/v1/webhook-events/recent
```

–ò–ª–∏ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ: `/admin/instagram-test`

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –¥–ª—è Self Messaging:

```bash
aws logs tail /ecs/doctor-agent --region me-central-1 --since 1h | grep -i "self messaging"
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
üéØ SELF MESSAGING WEBHOOK –û–ë–ù–ê–†–£–ñ–ï–ù!
‚úÖ Instagram-scoped ID –¥–ª—è Self Messaging: <ID>
```

## –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

- ‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ —Å Account ID –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–æ–∂–∏–¥–∞–µ–º–æ)
- ‚ùå Self Messaging —Å Account ID –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–Ω—É–∂–µ–Ω Instagram-scoped ID)
- ‚úÖ Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –°–æ–±—ã—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
- ‚è≥ –û–∂–∏–¥–∞–µ–º webhook —Å–æ–±—ã—Ç–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ ID

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü–æ–ø—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç—É –≤ Instagram
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook —Å–æ–±—ã—Ç–∏–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `sender.id` –∏–∑ webhook –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
4. –ò–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∞–º–æ–º—É —Å–µ–±–µ —á–µ—Ä–µ–∑ Instagram app –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `recipient.id` –¥–ª—è Self Messaging

