# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π Instagram webhook

## –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π**: –¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `message_edit`, `message_reaction` –∏ –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π, –Ω–µ –ø—ã—Ç–∞—è—Å—å –∏–∑–≤–ª–µ—á—å –∏–∑ –Ω–∏—Ö sender/recipient ID
2. **–£–ª—É—á—à–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ ID**: –°–∏—Å—Ç–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç ID —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
3. **–£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ**: Frontend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è –∏ –æ–±—ä—è—Å–Ω—è–µ—Ç, –ø–æ—á–µ–º—É ID –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã

## –î–µ–ø–ª–æ–π

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç—ã –¥–µ–ø–ª–æ—è

```bash
cd infra

# –ù–∞—Å—Ç—Ä–æ–π—Ç–µ AWS credentials –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
aws configure
# –∏–ª–∏
export AWS_ACCESS_KEY_ID=...
export AWS_SECRET_ACCESS_KEY=...

# –î–µ–ø–ª–æ–π backend
bash DEPLOY_BACKEND.sh

# –î–µ–ø–ª–æ–π frontend
bash DEPLOY_FRONTEND.sh
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CI/CD

–ò–∑–º–µ–Ω–µ–Ω–∏—è —É–∂–µ –∑–∞–ø—É—à–µ–Ω—ã –≤ `main` –≤–µ—Ç–∫—É, CI/CD –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook —Å–æ–±—ã—Ç–∏–π

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:

1. –û—Ç–∫—Ä–æ–π—Ç–µ `/admin/instagram-test`
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç—É –≤ Instagram
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ webhook —Å–æ–±—ã—Ç–∏–µ –ø–æ—è–≤–∏–ª–æ—Å—å
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è Sender ID –∏ Recipient ID

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è

#### –í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

1. –û—Ç–∫—Ä–æ–π—Ç–µ `/admin/instagram-test`
2. –î–æ–∂–¥–∏—Ç–µ—Å—å webhook —Å–æ–±—ã—Ç–∏—è —Å –æ–±—ã—á–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º (–Ω–µ message_edit)
3. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Sender ID" - –ø–æ–ª–µ Recipient ID –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ Account ID (—ç—Ç–æ recipient.id –∏–∑ webhook)
5. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"

#### –í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ API)
python3 test_send_from_webhook.py <access_token>

# Access token –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∏–∑:
# - Channel binding –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
# - AWS Secrets Manager: doctor-agent/instagram-<binding_id>
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
aws logs tail /ecs/doctor-agent --region me-central-1 --since 10m | grep -E "(webhook|event_type|Sender ID)"
```

–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:
- `üîπ –¢–∏–ø —Å–æ–±—ã—Ç–∏—è: message` - –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- `üîπ –¢–∏–ø —Å–æ–±—ã—Ç–∏—è: message_edit` - –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- `‚úÖ –ù–ê–ô–î–ï–ù RECIPIENT_ID: <id>` - –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å sender.id

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –ü–æ—á–µ–º—É –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∞:

1. **24-—á–∞—Å–æ–≤–æ–µ –æ–∫–Ω–æ**: Instagram –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ `sender.id` –∏–∑ webhook –∫–∞–∫ `recipient_id` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
3. **–¢–∏–ø —Å–æ–±—ã—Ç–∏—è**: –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –Ω—É–∂–Ω–æ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (`event_type='message'`), –∞ –Ω–µ `message_edit` –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ webhook —Å–æ–±—ã—Ç–∏–π:

**–û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç):**
```json
{
  "object": "instagram",
  "entry": [{
    "messaging": [{
      "sender": {"id": "USER_ID"},  // ‚Üê –≠—Ç–æ recipient_id –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
      "recipient": {"id": "ACCOUNT_ID"},  // ‚Üê –≠—Ç–æ account_id –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
      "message": {
        "text": "–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è",
        "mid": "message_id"
      }
    }]
  }]
}
```

**–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç):**
```json
{
  "object": "instagram",
  "entry": [{
    "messaging": [{
      "message_edit": {
        "mid": "message_id",
        "num_edit": 0
      }
      // –ù–µ—Ç sender/recipient!
    }]
  }]
}
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ó–∞–¥–µ–ø–ª–æ–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç—É –≤ Instagram (–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Å—Ç–∞—Ä–æ–µ!)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook —Å–æ–±—ã—Ç–∏–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Sender ID –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
5. –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –æ—Ç–ª–∏—á–Ω–æ! –ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ ID

